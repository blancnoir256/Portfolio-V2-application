name: Build and Update Manifest

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    # VPSにセットアップしたRunnerで実行
    runs-on: self-hosted

    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v3

      - name: Set Image Tag
        id: image_tag
        # コミットハッシュの先頭7文字をイメージタグにする
        run: echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build Docker Image
        run: |
          # プロジェクトルートでビルド
          docker build -t portfolio-app:${{ steps.image_tag.outputs.tag }} .

      - name: Import Image to microk8s
        # ビルドしたイメージをtarにして、microk8sの内部レジストリにインポート
        run: |
          docker save portfolio-app:${{ steps.image_tag.outputs.tag }} > app-image.tar
          microk8s ctr image import app-image.tar

      - name: Checkout Manifest Repo
        # manifestをチェックアウト
        uses: actions/checkout@v3
        with:
          repository: blancnoir256/Portfolio-V2-infra
          path: 'manifest-repo'
          # manifest-repoにpushするための認証情報
          token: ${{ secrets.MANIFEST_REPO_PAT }}

      - name: Update Kubernetes Manifest
        # kustomizeコマンドでimageタグを更新
        run: |
          cd manifest-repo
          # 単一イメージを更新
          kustomize edit set image portfolio-app=portfolio-app:${{ steps.image_tag.outputs.tag }}

      - name: Commit and Push Changes
        # 変更をmanifest-repoにPush
        run: |
          cd manifest-repo
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "Update image tag to ${{ steps.image_tag.outputs.tag }}"
          git push

      - name: Run Backend Tests
        run: |
          cd backend
          go test ./...

      - name: Run Frontend Tests
        run: |
          cd frontend
          npm ci
          npm run test

      - name: Apply and Verify Deployment
        run: |
          microk8s kubectl apply -k manifest-repo/
          # デプロイ状態の確認
          microk8s kubectl rollout status deployment/portfolio-app -n default --timeout=120s
